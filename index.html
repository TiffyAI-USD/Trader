<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>TIFFY Trader • Bucks Dashboard</title>
  <meta name="description" content="Your private TIFFYAI trading portal. Share, earn, trade. Fingerprint-gated." />
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#ff69b4" />
  <link rel="icon" href="icon.png" type="image/png" />

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Poppins:wght@300;500&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background: #000;
      color: #fff;
      overflow: hidden;
      touch-action: pan-y;
    }
    #scene-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
    
    /* Floating UI Panel */
    #ui-panel {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(20, 20, 40, 0.9);
      backdrop-filter: blur(12px);
      border: 1px solid #ff69b4;
      border-radius: 16px;
      padding: 16px;
      z-index: 100;
      max-width: 300px;
      box-shadow: 0 0 20px rgba(255, 105, 180, 0.4);
      transition: all 0.3s ease;
    }
    #ui-panel.hidden { transform: translateX(320px); }
    #toggle-ui { 
      position: fixed; top: 20px; right: 20px; z-index: 101; 
      background: #ff69b4; color: #000; border: none; 
      width: 40px; height: 40px; border-radius: 50%; 
      font-size: 20px; cursor: pointer; 
    }

    /* Counter */
    #tiffy-counter {
      font-family: 'Orbitron', sans-serif;
      font-size: 24px;
      color: #ff69b4;
      text-shadow: 0 0 10px #ff69b4;
      text-align: center;
      margin-bottom: 12px;
    }

    /* Buttons */
    button {
      background: linear-gradient(45deg, #ff69b4, #ff1493);
      border: none;
      color: #fff;
      padding: 12px 16px;
      margin: 6px 0;
      border-radius: 12px;
      width: 100%;
      font-weight: 500;
      cursor: pointer;
      transition: 0.3s;
      font-size: 14px;
    }
    button:hover { transform: scale(1.05); box-shadow: 0 0 15px #ff69b4; }
    button:active { transform: scale(0.98); }

    /* Share Modal */
    #share-modal {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      display: none; justify-content: center; align-items: center;
      z-index: 200;
    }
    #share-box {
      background: #111;
      padding: 20px;
      border-radius: 16px;
      border: 1px solid #ff69b4;
      text-align: center;
      max-width: 90%;
    }
    #ref-link {
      background: #222;
      padding: 12px;
      border-radius: 8px;
      margin: 12px 0;
      word-break: break-all;
      font-family: monospace;
      color: #0f0;
    }

    /* Voice Status */
    #voice-status {
      font-size: 12px;
      color: #aaa;
      margin-top: 8px;
    }

    /* Loading */
    #loader {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #000; display: flex; justify-content: center; align-items: center;
      z-index: 999; flex-direction: column; color: #ff69b4;
    }
    #loader.hidden { display: none; }

    /* 3D Text Glow */
    .glow-text { text-shadow: 0 0 10px #ff69b4, 0 0 20px #ff1493; }

    /* Floating Particles */
    .particle {
      width: 4px; height: 4px; background: #ff69b4; border-radius: 50%;
      position: absolute; opacity: 0.8; pointer-events: none;
      animation: float 6s infinite ease-in-out;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(180deg); }
    }
  </style>
</head>
<body>

  <!-- Loader -->
  <div id="loader">
    <h2>TIFFYAI • Activating Portal...</h2>
    <p>Hold tight, honey. Fingerprint sync in progress.</p>
    <p style="font-size:12px; margin-top:20px;">Verifying your soulprint... 99.9%</p>
    <div style="margin-top:20px; width:200px; height:4px; background:#333; border-radius:2px; overflow:hidden;">
      <div style="width:99%; height:100%; background:#ff69b4; animation: pulse 1.5s infinite;"></div>
    </div>
  </div>

  <!-- A-Frame 3D Scene -->
  <div id="scene-container">
    <a-scene 
      embedded 
      background="color: #000" 
      renderer="antialias: true" 
      vr-mode-ui="enabled: false"
      shadow="type: pcfsoft"
      fog="type: linear; color: #000; near: 10; far: 50"
      cursor="rayOrigin: mouse"
    >
      <a-assets timeout="10000">
        <img id="sky" src="sky.jpg" crossorigin="anonymous" />
        <audio id="click-sound" src="click.mp3" preload="auto"></audio>
        <audio id="reward-sound" src="reward.mp3" preload="auto"></audio>
        <audio id="voice-welcome" src="welcome.mp3" preload="auto"></audio>
        <img id="grid" src="grid.png" crossorigin="anonymous" />
      </a-assets>

      <!-- Sky -->
      <a-sky src="#sky" rotation="0 -90 0" animation="property: rotation; to: 0 -450 0; loop: true; dur: 120000; easing: linear"></a-sky>

      <!-- Floating TIFFY Orb -->
      <a-entity position="0 2 -4">
        <a-sphere 
          radius="0.8" 
          color="#ff69b4" 
          emissive="#ff1493" 
          emissive-intensity="0.8"
          metalness="0.3"
          roughness="0.4"
          animation="property: rotation; to: 0 360 0; loop: true; dur: 10000; easing: linear"
          animation__pulse="property: scale; from: 1 1 1; to: 1.1 1.1 1.1; loop: true; dir: alternate; dur: 2000; easing: easeInOutSine"
          shadow="receive: false; cast: true"
        >
          <a-text 
            value="TIFFY" 
            position="0 0 0.9" 
            align="center" 
            color="#000" 
            width="3"
            font="https://cdn.aframe.io/fonts/Orbitron_Bold.json"
            class="glow-text"
            animation="property: rotation; to: 0 360 0; loop: true; dur: 15000; easing: linear"
          ></a-text>
        </a-sphere>
      </a-entity>

      <!-- Secondary Orbs -->
      <a-entity position="-3 1.5 -6">
        <a-sphere radius="0.3" color="#ff1493" opacity="0.7" animation="property: position; to: -3 2.5 -6; loop: true; dir: alternate; dur: 3000"></a-sphere>
      </a-entity>
      <a-entity position="3 1.8 -5">
        <a-sphere radius="0.25" color="#ff69b4" opacity="0.6" animation="property: position; to: 3 2.8 -5; loop: true; dir: alternate; dur: 4000"></a-sphere>
      </a-entity>
      <a-entity position="0 3 -7">
        <a-sphere radius="0.2" color="#ff69b4" opacity="0.5" animation="property: position; to: 0 4 -7; loop: true; dir: alternate; dur: 5000"></a-sphere>
      </a-entity>

      <!-- Ground Grid -->
      <a-plane 
        position="0 0 -4" 
        rotation="-90 0 0" 
        width="30" height="30" 
        color="#111" 
        opacity="0.8" 
        material="src: #grid; repeat: 15 15; metalness: 0.2; roughness: 0.8"
        shadow="receive: true"
      ></a-plane>

      <!-- Ambient Lights -->
      <a-light type="ambient" color="#403060" intensity="0.4"></a-light>
      <a-light type="directional" position="5 10 5" intensity="0.6" castShadow="true"></a-light>

      <!-- Camera -->
      <a-camera position="0 1.6 0" wasd-controls-enabled="false">
        <a-cursor 
          color="#ff69b4" 
          fuse="true" 
          fuseTimeout="1500"
          animation__click="property: scale; startEvents: click; from: 0.1 0.1 0.1; to: 1 1 1; dur: 150"
          animation__fusing="property: scale; startEvents: fusing; from: 1 1 1; to: 0.1 0.1 0.1; dur: 1500"
        ></a-cursor>
      </a-camera>

      <!-- Interactive Trade Button in 3D -->
      <a-entity position="0 1.2 -2.5" class="clickable" onclick="startTrading()">
        <a-box depth="0.1" height="0.6" width="2" color="#ff1493" opacity="0.9"
               animation__hover="property: position; to: 0 1.3 -2.5; startEvents: mouseenter; dur: 200"
               animation__leave="property: position; to: 0 1.2 -2.5; startEvents: mouseleave; dur: 200">
          <a-text value="START 2 TRADES" align="center" color="#fff" position="0 0 0.06" width="3"></a-text>
        </a-box>
      </a-entity>

      <!-- Share Button in 3D -->
      <a-entity position="-1.5 0.8 -2" class="clickable" onclick="openShareModal()">
        <a-cylinder radius="0.4" height="0.1" color="#ff69b4" opacity="0.9"></a-cylinder>
        <a-text value="SHARE & EARN" align="center" color="#000" position="0 0.1 0" width="2.5"></a-text>
      </a-entity>

      <!-- Claim Button in 3D -->
      <a-entity position="1.5 0.8 -2" class="clickable" onclick="claimRewards()">
        <a-cylinder radius="0.4" height="0.1" color="#ff1493" opacity="0.9"></a-cylinder>
        <a-text value="CLAIM" align="center" color="#fff" position="0 0.1 0" width="2"></a-text>
      </a-entity>

    </a-scene>
  </div>

  <!-- Floating UI Panel -->
  <button id="toggle-ui">></button>
  <div id="ui-panel">
    <div id="tiffy-counter">TIFFYAI: 0.00</div>
    <button id="connect-wallet">Connect Wallet</button>
    <button id="refresh-balances">Refresh Balances</button>
    <button id="share-button">Share & Earn</button>
    <button id="start-trading">Start 2 Trades</button>
    <button id="claim-rewards">Claim Rewards</button>
    <div id="voice-status">Voice: Initializing...</div>
    <div id="debug-log" style="font-size:10px; color:#666; margin-top:10px; max-height:60px; overflow-y:auto;"></div>
  </div>

  <!-- Share Modal -->
  <div id="share-modal">
    <div id="share-box">
      <h3>Share & Earn 500 TIFFYAI!</h3>
      <p>Post this link on X — reward in <strong>60 seconds</strong> if you don't cancel.</p>
      <div id="ref-link">Loading your link...</div>
      <button id="copy-link">Copy & Post on X</button>
      <button id="close-share">Cancel</button>
      <p style="font-size:12px; margin-top:10px; color:#aaa;">Timer: <span id="share-timer">60</span>s</p>
    </div>
  </div>

  <!-- Floating Particles Container -->
  <div id="particles"></div>

  <!-- Scripts -->
  <script>
    // === CONFIGURATION ===
    const RENDER_API = 'https://bucks-bj2k.onrender.com';
    const REPO_BASE = 'https://tiffyai.github.io/Bucks';
    const ADMIN_KEY = 'tHisiSm17e2tkey1234567890987654321234567890987654321234567890987';
    const SHARE_REWARD = 500;
    const TRADE_FEE = 0.003; // BNB
    const MAX_TRADES = 2;

    // === STATE ===
    const userId = localStorage.getItem('userId') || 'user_' + Date.now();
    if (!localStorage.getItem('userId')) localStorage.setItem('userId', userId);
    let userName = localStorage.getItem('userName') || 'Honey';
    let walletAddress = localStorage.getItem('wallet') || null;
    let tiffyBalance = parseFloat(localStorage.getItem('tiffy') || '0');
    let shareTimeout = null;
    let shareTimerInterval = null;

    // === DOM ===
    const loader = document.getElementById('loader');
    const counter = document.getElementById('tiffy-counter');
    const connectBtn = document.getElementById('connect-wallet');
    const refreshBtn = document.getElementById('refresh-balances');
    const shareBtn = document.getElementById('share-button');
    const tradeBtn = document.getElementById('start-trading');
    const claimBtn = document.getElementById('claim-rewards');
    const modal = document.getElementById('share-modal');
    const refLink = document.getElementById('ref-link');
    const copyBtn = document.getElementById('copy-link');
    const closeShare = document.getElementById('close-share');
    const voiceStatus = document.getElementById('voice-status');
    const toggleUI = document.getElementById('toggle-ui');
    const uiPanel = document.getElementById('ui-panel');
    const debugLog = document.getElementById('debug-log');
    const shareTimer = document.getElementById('share-timer');
    const particles = document.getElementById('particles');

    // === INIT ===
    setTimeout(() => loader.classList.add('hidden'), 2000);
    updateCounter();
    setupVoice();
    setupShareTimer();
    createParticles();
    log('System initialized');

    // === UI TOGGLE ===
    toggleUI.onclick = () => {
      uiPanel.classList.toggle('hidden');
      toggleUI.textContent = uiPanel.classList.contains('hidden') ? '<' : '>';
    };

    // === WALLET CONNECT ===
    connectBtn.onclick = async () => {
      if (typeof window.ethereum === 'undefined') {
        alert('Please install MetaMask!');
        return;
      }
      try {
        const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
        walletAddress = accounts[0];
        localStorage.setItem('wallet', walletAddress);
        alert('Wallet connected: ' + walletAddress.slice(0,6) + '...' + walletAddress.slice(-4));
        log('Wallet connected');
        fetchBalances();
      } catch (err) {
        alert('Connection failed: ' + err.message);
        log('Wallet error: ' + err.message);
      }
    };

    // === FETCH BALANCES ===
    async function fetchBalances() {
      if (!walletAddress) return;
      try {
        const res = await fetch(`${RENDER_API}/wallets?address=${walletAddress}`);
        const data = await res.json();
        if (data.tiffy !== undefined) {
          tiffyBalance = data.tiffy;
          localStorage.setItem('tiffy', tiffyBalance);
          updateCounter();
          log('Balance synced: ' + tiffyBalance);
        }
      } catch (err) {
        log('Balance fetch failed: ' + err.message);
      }
    }
    refreshBtn.onclick = fetchBalances;

    // === UPDATE COUNTER ===
    function updateCounter() {
      counter.textContent = `TIFFYAI: ${tiffyBalance.toFixed(2)}`;
    }

    // === LOGGING ===
    function log(msg) {
      const time = new Date().toLocaleTimeString();
      debugLog.innerHTML += `<div>[${time}] ${msg}</div>`;
      debugLog.scrollTop = debugLog.scrollHeight;
    }

    // === PARTICLES ===
    function createParticles() {
      for (let i = 0; i < 30; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        p.style.left = Math.random() * 100 + '%';
        p.style.top = Math.random() * 100 + '%';
        p.style.animationDelay = Math.random() * 6 + 's';
        p.style.animationDuration = (Math.random() * 3 + 3) + 's';
        particles.appendChild(p);
      }
    }

    // === SHARE & EARN: 60-SECOND ANTI-CANCEL ===
    shareBtn.onclick = openShareModal;
    function openShareModal() {
      const link = `${REPO_BASE}?ref=${userId}`;
      refLink.textContent = link;
      modal.style.display = 'flex';

      // Notify backend
      fetch(`${RENDER_API}/share-state`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId, status: 'pending' })
      });

      localStorage.setItem('shareStatus', 'pending');
      localStorage.setItem('shareStart', Date.now());
      log('Share started');

      // Timer UI
      let timeLeft = 60;
      shareTimer.textContent = timeLeft;
      shareTimerInterval = setInterval(() => {
        timeLeft--;
        shareTimer.textContent = timeLeft;
        if (timeLeft <= 0) clearInterval(shareTimerInterval);
      }, 1000);

      // Auto-claim after 60s
      shareTimeout = setTimeout(() => {
        if (localStorage.getItem('shareStatus') === 'pending') {
          claimShareReward();
        }
      }, 60000);
    }

    copyBtn.onclick = () => {
      navigator.clipboard.writeText(refLink.textContent);
      window.open(`https://x.com/intent/post?text=Join%20TIFFYAI%20and%20earn%20with%20me!%20${encodeURIComponent(refLink.textContent)}`, '_blank');
      log('Link copied & X opened');
    };

    closeShare.onclick = cancelShare;
    function cancelShare() {
      modal.style.display = 'none';
      localStorage.setItem('shareStatus', 'canceled');
      fetch(`${RENDER_API}/share-state`, {
        method: 'POST',
        body: JSON.stringify({ userId, status: 'canceled' })
      });
      clearTimeout(shareTimeout);
      clearInterval(shareTimerInterval);
      log('Share canceled');
    }

    // Cancel on outside tap or back
    document.addEventListener('click', (e) => {
      if (localStorage.getItem('shareStatus') === 'pending' && !e.target.closest('#share-modal')) {
        cancelShare();
      }
    });
    window.addEventListener('popstate', cancelShare);

    async function claimShareReward() {
      try {
        const res = await fetch(`${RENDER_API}/trades`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'claim_share_reward', userId, wallet: walletAddress, timestamp: Date.now() })
        });
        const data = await res.json();
        if (data.success) {
          tiffyBalance += data.amount;
          localStorage.setItem('tiffy', tiffyBalance);
          updateCounter();
          playSound('reward-sound');
          alert(`You earned ${data.amount} TIFFYAI!`);
          log(`Reward claimed: +${data.amount}`);
          localStorage.setItem('shareStatus', 'completed');
          fetch(`${RENDER_API}/share-state`, { method: 'POST', body: JSON.stringify({ userId, status: 'clear' }) });
        } else {
          alert('Reward failed: ' + data.error);
          log('Reward error: ' + data.error);
        }
      } catch (err) {
        log('Claim failed: ' + err.message);
      }
      modal.style.display = 'none';
      clearInterval(shareTimerInterval);
    }

    // === TRADING ===
    tradeBtn.onclick = startTrading;
    async function startTrading() {
      if (!walletAddress) return alert('Connect wallet first!');
      try {
        const res = await fetch(`${RENDER_API}/trades`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'start_trades', userId, wallet: walletAddress, count: 2 })
        });
        const data = await res.json();
        alert(data.message || 'Trades started!');
        log('Trades initiated');
        setTimeout(fetchBalances, 5000);
      } catch (err) {
        alert('Trade failed');
        log('Trade error: ' + err.message);
      }
    }

    // === CLAIM REWARDS ===
    claimBtn.onclick = claimRewards;
    async function claimRewards() {
      try {
        const res = await fetch(`${RENDER_API}/trades`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'claim_all', userId, wallet: walletAddress })
        });
        const data = await res.json();
        alert(data.message);
        log('Claim attempted');
        fetchBalances();
      } catch (err) {
        log('Claim error: ' + err.message);
      }
    }

    // === SOUND ===
    function playSound(id) {
      const sound = document.getElementById(id);
      if (sound) sound.play().catch(() => {});
    }

    // === VOICE ===
    function setupVoice() {
      if ('speechSynthesis' in window) {
        const voices = speechSynthesis.getVoices();
        const female = voices.find(v => v.name.includes('Karen') || v.name.includes('Samantha')) || voices[0];
        window.speak = (text) => {
          const utter = new SpeechSynthesisUtterance(text);
          utter.voice = female;
          utter.rate = 0.9;
          speechSynthesis.speak(utter);
        };
        voiceStatus.textContent = 'Voice: Ready';
        setTimeout(() => {
          speak(`Welcome back, ${userName}`);
          playSound('voice-welcome');
        }, 2500);
        log('Voice ready');
      } else {
        voiceStatus.textContent = 'Voice: Not supported';
      }
    }

    // === RESUME SHARE TIMER ===
    function setupShareTimer() {
      const status = localStorage.getItem('shareStatus');
      if (status === 'pending') {
        const start = parseInt(localStorage.getItem('shareStart'));
        const elapsed = Date.now() - start;
        if (elapsed < 60000) {
          shareTimeout = setTimeout(claimShareReward, 60000 - elapsed);
          openShareModal(); // Reopen modal
        } else {
          localStorage.setItem('shareStatus', 'canceled');
        }
      }
    }

    // === PWA INSTALL ===
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      setTimeout(() => {
        if (confirm('Install TIFFY Trader App?')) deferredPrompt.prompt();
      }, 10000);
    });

    // === SERVICE WORKER ===
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/Bucks/sw.js')
          .then(reg => log('SW registered'))
          .catch(err => log('SW failed: ' + err));
      });
    }

    // === 3D INTERACTIONS ===
    document.querySelectorAll('.clickable').forEach(el => {
      el.addEventListener('click', () => playSound('click-sound'));
    });
  </script>
</body>
</html>
